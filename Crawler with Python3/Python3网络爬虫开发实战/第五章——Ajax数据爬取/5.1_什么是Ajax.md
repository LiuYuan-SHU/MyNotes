> 有时我们用requests抓取页面得到的结果，可能和在浏览器中看到的不一样：在浏览器中可以看到正常显示的页面数据，而是用requests得到的结果中并没有这些数据。这是因为requests获取的都是原始HTML文档，而浏览器中的页面是JavaScript处理数据后生成的结果，这些数据有多种来源：可能是Ajax加载的，可能是包含在HTML文档中的，也可能是经过JavaScript和特定算法计算后生成的。
>
> 对于第一种来源，数据加载是一种异步加载方式，原始页面最初不会包含某些数据，当原始页面加载完后，会再向服务器请求某个接口获取数据，然后数据才会经过处理从而呈现在网页上，这其实是发送了一个Ajax请求。
>
> 按照Web的发展趋势来看，这种形式的页面越来越多。甚至网页的原始HTML文档不包含任何数据，数据都是通过Ajax统一加载后呈现出来的，这样使得Web开发可以做到前后端分离，减小服务器直接渲染页面带来的压力。
>
> 遇到这样的页面，直接利用requests等库直接抓取原始HTML文档，是无法获取有效数据的，这时需要分析网页后台向接口发送的Ajax请求。如果可以直接用requests模拟Ajax请求，就可以成功抓取数据了。



> Ajax，全称为**Asynchronous JavaScript and XML**，即异步JavaScript和XML。它不是一门编程语言，而是利用JavaScript在保证页面不被刷新、页面链接不被改变的情况下与服务器交换数据并更新部分网页内容的技术。
>
> 对于传统的网页，如果想更新其内容，就必须刷新整个页面，但有了Ajax，可以在页面不被全部刷新的情况下更新。这个过程实际上是页面在后台与服务器进行了数据交互，获取数据之后，再利用JavaScript改变网页，这样网页内容就会更新了。

# 2. 基本原理

从发送Ajax请求到网页更新的这个过程可以简单分为以下3步——发送请求、解析内容、渲染网页。

## 发送请求

JavaScript可以实现页面的各种交互功能，Ajax也不例外，它也是由JavaScript实现的，实现代码如下：

```javascript
var xmlhttp;
if (window.XMLHttpRequest) {
    xmlhttp=new XMLHttpRequest();
} else { //code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")
}
xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
        document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
    }
}
xmlhttp.open("POST", "/ajax/", true);
xmlhttp.send();
```

这是JavaScript对Ajax最底层的实现，实际上就是先新建一个`XMLHttpRequest`对象`xmlhttp`，然后调用`onreadystatechange`竖向设置监听，最后调用`open`和`send`方法向某个链接（也就是服务器）发送请求。前面用Python实现请求发送之后，可以得到响应结果，但这里的请求发送由JavaScript完成。由于设置了监听，所以大概服务器返回响应的时候，`onreadystatechange`对应的方法便会被触发，然后再这个方法里面解析相应内容即可。

## 解析内容

服务器返回响应之后，`onreadystatechange`属性对应的方法就被出发了，此时利用`xmlhttp`的`responseText`属性便可以得到相应内容。这类似于Python中利用`requests`向服务器发起请求，然后得到相应的过程。返回内容可能是HTML，可能是JSON，接下来只需要在方法中用JavaScript进一步处理即可。如果是JSON的话，可以进行解析和转化。

## 渲染网页

JavaScript有改变网页内容的能力，因此解析完响应内容之后，就可以调用JavaScript来基于解析完的内容对网页进行下一步处理了。例如，通过`document=getElementById().innerHTML`操作，可以更改某个元素内的源代码，这样网页显示的内容就被改变了。这种操作也被称作DOM操作，即对网页文档进行操作，如更改、删除等。

上面的“发送请求”的部分，代码里的`document.getElementById("myDiv").innerHTML=xmlhttp.responseText`便是讲`id`为`mydiv`的节点内部的HTML代码更改为了服务器返回的内容，这样`mydiv`元素内部便会呈现服务器返回的新数据，对应的网页内容看上去就更新了。

